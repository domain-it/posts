/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var U=Object.defineProperty;var At=Object.getOwnPropertyDescriptor;var wt=Object.getOwnPropertyNames;var Ct=Object.prototype.hasOwnProperty;var Et=(a,e)=>{for(var t in e)U(a,t,{get:e[t],enumerable:!0})},Mt=(a,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of wt(e))!Ct.call(a,s)&&s!==t&&U(a,s,{get:()=>e[s],enumerable:!(i=At(e,s))||i.enumerable});return a};var It=a=>Mt(U({},"__esModule",{value:!0}),a);var $t={};Et($t,{default:()=>H});module.exports=It($t);var b=require("obsidian"),xt=require("@codemirror/view");var y="abbreviations-plugin-abbr-element",_="abbreviations-plugin-extra-definition",st="abbreviations-plugin-extra-asterisk",M="abbreviations-plugin-extra-definition-line",nt="abbreviations-plugin-preview-decorator",at="abbreviations-plugin-source-decorator",I="p, li, h1, h2, h3, h4, h5, h6, th, td, .table-cell-wrapper, .callout-title-inner",x="---";var Z=require("obsidian"),k=require("@codemirror/view"),A=require("@codemirror/state");function ot(a){return/\s/.test(a)}function w(a){return a==="-"||a==="&"?!1:/\s/.test(a)?!0:!/^[\p{L}\p{N}\p{Ideographic}]$/u.test(a)}function S(a){if(a==="")return!1;for(let e of a)if(w(e))return!1;return!0}function m(a,e){return a&&e?a.split(e).length-1:0}function rt(a){let e=[],t=0,i=!0,s="";for(let n of a){let o=w(n);t===0?(++t,i=o,s+=n):i===o?s+=n:(e.push({text:s,isSpecial:i}),i=o,s=n,++t)}return s&&e.push({text:s,isSpecial:i}),e}function N(a){let e=a.match(/^\*\[([^[\]]+?)\]:(\s+.*)?$/);return e?{key:e[1],title:(e[2]||"").trim()}:null}function lt(a){let e=a.split(`
`),t=0;for(let i of e)if(i.match(/^\*\[[^[\]]+?\]:(\s+.*)?$/)){t=0;continue}else if(i.match(/^\[[^[\]]+?\]:(\s+.*)?$/))if(t===0){t=1;continue}else t=0;else return!1;return t===0}function ct(a){return Array.from(new Set(a.split(",").map(e=>e.trim()).filter(e=>e)))}function dt(a){if(typeof a=="string"){let e=a.trim(),t=e.indexOf(":");if(t>0)return{key:e.substring(0,t).trim(),title:e.substring(t+1).trim(),type:"metadata"}}else if(typeof a=="object"&&a){let e=Object.keys(a);if(e.length===1&&typeof a[e[0]]=="string")return{key:e[0],title:a[e[0]],type:"metadata"}}return null}function St(a,e){if(e.length===0)return[];let t=[],i=0;for(;i<a.length;){let s=a.indexOf(e,i);if(s===-1)break;t.push(s),i=s+1}return t}function z(a,e){let t=a.index,i=a.index+a.text.length,s=e.index,n=e.index+e.text.length;return t===s&&i===n?"same":t<=s&&i>=n?"contain":t>=s&&i<=n?"included":i>s&&t<n?"intersection":"unrelated"}function Tt(a){let e=[];if(a.length===0)return[];let t=a.reduce((i,s,n)=>s.abbrPos<0?n:i,0);for(let i=t;i>=0;i--){let s=!0;for(let n of e)if(z(n,a[i])!=="unrelated"){s=!1;break}if(s){let{abbrPos:n,...o}=a[i];e.push({...o})}}for(let i=t+1;i<a.length;i++){let s=!0;for(let n of e)if(z(n,a[i])!=="unrelated"){s=!1;break}if(s){let{abbrPos:n,...o}=a[i];e.push({...o})}}return e}function $(a,e,t=1,i=[],s=!1){let n=null,o=null,r=[],d=i.length>0;for(let f=e.length-1;f>=0;f--){let l=e[f];if(l.key)if(a===l.key)if(n={...l,index:0,text:a},l.type==="extra"){if(l.position<=t)break}else break;else{if(d){let h=!1;for(let c of i)if(a===l.key+c){o={...l,index:0,text:a},h=!0;break}h&&(l.type==="extra"?l.position<=t&&(d=!1):d=!1)}if(s&&n==null&&o==null){let h=St(a,l.key);for(let c of h){let p=!0;r=r.filter(u=>{let g=z(u,{index:c,text:l.key});if(g==="same"){if(u.abbrPos>0)return!1;p=!1}else{if(g==="included")return!1;g==="contain"&&(p=!1)}return!0}),p&&r.push({...l,index:c,text:l.key,abbrPos:l.type==="extra"?l.position-t:-1})}}}}if(n!=null)return n.title?n:null;if(o!=null)return o.title?o:null;if(r.length>0){let f=Tt(r).filter(l=>l.title).sort((l,h)=>l.index-h.index);return f.length>0?f:null}return null}function T(a){if(a.length===0)return!0;let e=new Set;for(let t of a)if(t.key){if(t.type==="extra")return!1;t.title?e.add(t.key):e.delete(t.key)}return e.size===0}function D(a,e){let t=[];return e&&typeof a=="object"&&a&&Array.isArray(a[e])&&a[e].forEach(s=>{let n=dt(s);n&&t.push(n)}),t}function Q(a,e,t){if(Array.isArray(e[t])){let i=e[t],s=i.length-1;for(;s>=0;){let n=dt(i[s]);if(n&&n.key===a.key&&n.title===a.title)break;s--}return s}return-1}function X(a,e){let t=e.length-1;for(;t>=0;){let i=e[t];if(i&&i.key===a.key&&i.title===a.title)break;t--}return t}function Y(a,e,t=1,i=[],s=!1){var o;if(["DEL","EM","MARK","STRONG"].includes(a.nodeName)){let r=a.childNodes;for(let d=0;d<r.length;d++)Y(r[d],e,t,i,s)}if(a.nodeType!==Node.TEXT_NODE)return;let n=a.textContent;if(n){let r=createFragment();rt(n).forEach(f=>{if(f.isSpecial)r.appendChild(document.createTextNode(f.text));else{let l=$(f.text,e,t,i,s);if(Array.isArray(l)){let h=0;for(let c of l){c.index>h&&r.appendChild(document.createTextNode(f.text.substring(h,c.index)));let p=r.createEl("abbr",{cls:y,title:c.title,text:c.text,attr:{"data-abbr-key":c.key,"data-abbr-type":c.type,"data-abbr-position":(c.position||-1).toString()}});r.appendChild(p),h=c.index+c.text.length}h<f.text.length&&r.appendChild(document.createTextNode(f.text.substring(h)))}else if(l){let h=r.createEl("abbr",{cls:y,title:l.title,text:f.text,attr:{"data-abbr-key":l.key,"data-abbr-type":l.type,"data-abbr-position":(l.position||-1).toString()}});r.appendChild(h)}else r.appendChild(document.createTextNode(f.text))}}),(o=a.parentNode)==null||o.replaceChild(r,a)}}function O(a,e,t=[],i=!1){if(!T(e))for(let s of a){let n=s.childNodes;for(let o=0;o<n.length;o++){let r=n[o];Y(r,e,1,t,i)}}}function ft(a,e,t,i=[],s=!1){if(!T(t))for(let n of e){let o=a.getSectionInfo(n),r=(o==null?void 0:o.lineStart)||1,d=n.childNodes;for(let f=0;f<d.length;f++){let l=d[f];Y(l,t,r,i,s)}}}var C=class{constructor(){this.state="",this.codeBlocks={graveCount:0},this.quotes={level:0}}isMetadataState(){return this.state==="metadata"}};var ht=require("obsidian");function pt(a){return typeof a=="object"&&a?a:null}function Dt(a){try{let e=JSON.parse(a);return pt(e)}catch(e){return null}}function Ft(a){try{let e=(0,ht.parseYaml)(a);return pt(e)}catch(e){return null}}function bt(a){let e=Ft(a);return e===null&&(e=Dt(a)),e}var v=class extends C{constructor(e,t,i){super(),this.abbreviations=e.map(({key:s,title:n})=>({key:s,title:n,type:"global"})).filter(s=>s.key),this.abbreviationKeyword=t,this.parseOption=i,this.metadataBuffer=[]}readAbbreviationsFromCache(e){let t=D(e,this.abbreviationKeyword);this.abbreviations.push(...t)}isAbbreviationsEmpty(){return T(this.abbreviations)}handler(e,t){if(t===1&&e===x){this.state="metadata";return}if(this.quotes.level>0&&this.state!=="math"&&e.trim().length===0){this.state="",this.codeBlocks.graveCount=0,this.quotes.level=0;return}if(this.state===""){if(/^(?:[ ]{4,}|\t|[> ]+(?:[ ]{5,}|\t))/.test(e))return;let i=e.match(/^([> ]*`{3,})[^`]*$/);if(i){this.state="codeBlocks",this.codeBlocks.graveCount=m(i[1],"`"),this.quotes.level=m(i[1],">");return}let s=e.match(/^([> ]*)\$\$(.*)/);if(s&&!s[2].trim().endsWith("$$")){this.state="math",this.quotes.level=m(s[1],">");return}if(this.parseOption.extra){let n=N(e);n&&this.abbreviations.push({key:n.key,title:n.title,type:"extra",position:t})}}else if(this.state==="metadata")if(e===x){if(this.parseOption.metadata&&this.abbreviationKeyword&&this.metadataBuffer.length>0){let i=bt(this.metadataBuffer.join(`
`));if(i){let s=D(i,this.abbreviationKeyword);this.abbreviations.push(...s)}}this.state=""}else this.parseOption.metadata&&this.abbreviationKeyword&&this.metadataBuffer.push(e);else if(this.state==="codeBlocks"){let i=e.match(/^([> ]*`{3,})([^`]*)$/);if(i){let s=m(i[1],">"),n=m(i[1],"`");s<this.quotes.level?(this.quotes.level=s,this.codeBlocks.graveCount=n):s===this.quotes.level&&n>=this.codeBlocks.graveCount&&i[2].trim().length===0&&(this.state="")}}else if(this.state==="math"){let i=e.match(/^([> ]*)\$\$/);if(i){let s=m(i[1],">");s<this.quotes.level?this.quotes.level=s:s===this.quotes.level&&(this.state="")}}}};var B=class{constructor(){this.grave={isStart:!1,startLen:0,count:0};this.link={mode:"end",wait:"",openLen:0,closeCount:0,isInlineFootnote:!1};this.init()}init(){this.marks=[],this.buffer="",this.position=0,this.mode="separator",this.grave.isStart=!1,this.grave.startLen=0,this.grave.count=0,this.link.mode="end",this.link.wait="",this.link.openLen=0,this.link.closeCount=0,this.link.isInlineFootnote=!1}charHandler(e,t){if(this.mode==="inlineCode")t==="`"?(this.grave.isStart?this.grave.startLen++:this.grave.count++,this.buffer+=t):(this.grave.isStart=!1,this.grave.startLen===this.grave.count?(this.mode=w(t)?"separator":"word",this.grave.startLen=0,this.grave.count=0,this.buffer=t,this.position=e):(this.grave.count=0,this.buffer+=t));else if(this.mode==="inlineMath")t==="$"&&!this.isPrefixEscape(-1,!0)?(this.mode="word",this.buffer="",this.position=e+1):this.buffer+=t;else if(this.mode==="link"&&this.link.mode==="text"&&(this.link.wait!=="URLOpen"||this.link.wait==="URLOpen"&&t==="("))this.link.wait==="URLOpen"&&t==="("?this.link.wait="URLClose":this.link.wait==="textClose"&&t==="]"&&!this.isPrefixEscape()?(this.link.wait="",this.link.mode="end"):this.link.wait==="URLClose"&&t===")"&&!this.isPrefixEscape()?(this.link.wait="",this.link.mode="end"):t==="["&&!this.isPrefixEscape()&&this.link.openLen===1?this.link.openLen=2:t==="]"&&!this.isPrefixEscape()&&(this.link.closeCount++,this.link.openLen===1&&this.link.closeCount===1?this.link.isInlineFootnote?(this.link.wait="",this.link.mode="end"):this.link.wait="URLOpen":this.link.openLen===2&&this.link.closeCount===1?this.link.wait="textClose":this.link.mode="end"),this.buffer+=t;else if(t==="`"&&!this.isPrefixEscape())this.pushMark(),this.mode="inlineCode",this.grave.isStart=!0,this.grave.startLen=1,this.grave.count=0,this.buffer=t,this.position=e;else if(t==="$"&&!this.isPrefixEscape())this.pushMark(),this.mode="inlineMath",this.buffer=t,this.position=e;else if(t==="["&&!this.isPrefixEscape())this.pushMark(),this.mode="link",this.link.isInlineFootnote=this.buffer.at(-1)==="^"&&!this.isPrefixEscape(-2),this.link.mode="text",this.link.wait="",this.link.openLen=1,this.link.closeCount=0,this.buffer=t,this.position=e;else if(this.mode==="tag"){if("-_/".indexOf(t)>-1){this.buffer+=t;return}w(t)?(this.mode="separator",this.buffer=t,this.position=e):this.buffer+=t}else if(t==="#"&&!this.isPrefixEscape())this.mode==="separator"?this.buffer.length===0||ot(this.buffer.at(-1)||"")?(this.mode="tag",this.buffer=t,this.position=e):this.buffer+=t:(this.pushMark(),this.mode="separator",this.buffer=t,this.position=e);else{let i=w(t)?"separator":"word";i===this.mode?this.buffer+=t:(this.pushMark(),this.mode=i,this.buffer=t,this.position=e)}}pushMark(){this.mode==="word"&&this.buffer.length>0&&this.marks.push({text:this.buffer,position:this.position})}isPrefixEscape(e=-1,t=!1){return t?this.buffer.at(e)==="\\":this.buffer.at(e)==="\\"&&this.buffer.at(e-1)!=="\\"}handler(e){this.init();for(let t=0;t<e.length;t++)this.charHandler(t,e[t]);return this.pushMark(),this.marks}};var E=class extends C{constructor(e,t,i=[],s=!1){super(),this.abbreviations=e,this.skipExtraDefinition=t,this.affixList=i,this.detectCJK=s,this.listState=!1,this.mark=new B}handler(e,t,i){if(t===1&&e===x){this.state="metadata",i([],null);return}if(this.quotes.level>0&&this.state!=="math"&&e.trim().length===0){this.state="",this.codeBlocks.graveCount=0,this.quotes.level=0,this.listState=!1,i([],null);return}if(this.state===""){if(/^(?:[ ]{4,}|\t|[> ]+(?:[ ]{5,}|\t))/.test(e)&&!this.listState){i([],null);return}e.match(/^(?:[> \t]*[-*+][ ]{1,4}|[> \t]*\d+\.[ ]{1,4})/)?this.listState=!0:this.listState=!1;let s=e.match(/^([> ]*`{3,})[^`]*$/);if(s){this.state="codeBlocks",this.codeBlocks.graveCount=m(s[1],"`"),this.quotes.level=m(s[1],">"),i([],null);return}let n=e.match(/^([> ]*)\$\$(.*)/);if(n&&!n[2].trim().endsWith("$$")){this.state="math",this.quotes.level=m(n[1],">"),i([],null);return}if(this.skipExtraDefinition){let d=N(e);if(d){i([],d);return}}let o=[];this.mark.handler(e).forEach(d=>{let f=$(d.text,this.abbreviations,t,this.affixList,this.detectCJK);if(Array.isArray(f))for(let l of f){let{index:h,...c}=l;o.push({index:d.position+h,...c})}else if(f){let{index:l,text:h,...c}=f;o.push({index:d.position,text:d.text,...c})}}),i(o,null);return}else if(this.state==="metadata"){if(e===x){i([],null),this.state="";return}}else if(this.state==="codeBlocks"){let s=e.match(/^([> ]*`{3,})([^`]*)$/);if(s){let n=m(s[1],">"),o=m(s[1],"`");n<this.quotes.level?(this.quotes.level=n,this.codeBlocks.graveCount=o):n===this.quotes.level&&o>=this.codeBlocks.graveCount&&s[2].trim().length===0&&(this.state="")}}else if(this.state==="math"){let s=e.match(/^([> ]*)\$\$/);if(s){let n=m(s[1],">");n<this.quotes.level?this.quotes.level=n:n===this.quotes.level&&(this.state="")}}i([],null)}};var tt=A.StateEffect.define(),ut=A.StateField.define({create(){return k.Decoration.none},update(a,e){for(let t of e.effects)if(t.is(tt))return t.value;return a.map(e.changes)},provide:a=>k.EditorView.decorations.from(a)}),V=A.StateEffect.define(),mt=A.StateField.define({create:()=>!1,update(a,e){for(let t of e.effects)if(t.is(V))return t.value;return a}}),K=class{constructor(e,t){this.getPluginData=t,this.updateDecorations(e,e.state.field(Z.editorLivePreviewField))}update(e){(e.docChanged||e.viewportChanged||e.transactions.some(t=>t.effects.some(i=>i.is(V))))&&this.updateDecorations(e.view,e.state.field(Z.editorLivePreviewField))}destroy(){}async updateDecorations(e,t){let i=await this.getPluginData();if(t||i.markInSourceMode){let s=new A.RangeSetBuilder,n=e.state.doc,o=new v(i.globalAbbreviations,i.metadataKeyword,{metadata:!0,extra:i.useMarkdownExtraSyntax});for(let d=1;d<n.lines+1;d++){let l=n.line(d).text;if(d===1&&l!==x&&o.readAbbreviationsFromCache(i.frontmatterCache),o.handler(l,d),!i.useMarkdownExtraSyntax&&!o.isMetadataState())break}if(!o.isAbbreviationsEmpty()){let d=new E(o.abbreviations,i.useMarkdownExtraSyntax,i.suffixes,i.detectCJK);for(let f=1;f<n.lines+1;f++){let l=n.line(f),h=l.text;d.handler(h,f,(c,p)=>{if(p){let u={class:i.useExtraDefinitionDecorator?`${M} ${t?nt:at}`:M,"data-abbr-key":p.key,"data-abbr-title":p.title};i.useExtraDefinitionDecorator&&(u["data-abbr-decorator"]=i.extraDefinitionDecoratorContent.replaceAll("${abbr}",p.key).replaceAll("${tooltip}",p.title),u["data-decorator-opacity"]=`${i.extraDefinitionDecoratorOpacity}%`);let g=k.Decoration.line({attributes:u});if(s.add(l.from,l.from,g),t){let J=k.Decoration.mark({attributes:{class:st}});s.add(l.from,l.from+1,J)}}else c.forEach(u=>{let g=l.from+u.index,J=g+u.text.length,kt=k.Decoration.mark({tagName:"abbr",attributes:{text:u.text,title:u.title,class:y,"data-abbr-key":u.key,"data-abbr-type":u.type,"data-abbr-position":(u.position||-1).toString()}});s.add(g,J,kt)})})}}let r=s.finish();e.dispatch({effects:tt.of(r)}),O(e.dom.findAll(I),o.abbreviations,i.suffixes,i.detectCJK)}else e.dispatch({effects:tt.of(k.Decoration.none)})}};var F=require("obsidian");var P=class extends F.Modal{constructor(e,t,i){super(e),typeof t=="string"?this.selectedText=t:this.selectedAbbr=t,this.onSubmit=i}submitModal(e,t,i){e&&(this.close(),this.onSubmit(e,t,i))}onOpen(){let e="",t="";if(this.selectedAbbr){let{type:n,key:o,title:r}=this.selectedAbbr;this.setTitle(`Edit ${n} abbreviation`),e=o,t=r}else if(this.setTitle("Add metadata abbreviation"),this.selectedText){let n=this.selectedText.replace(/\n/," ").trim();S(n)?e=n:t=n}let{contentEl:i}=this;new F.Setting(i).setName("Abbreviation:").addText(n=>{n.setPlaceholder("Short word").setValue(e).onChange(r=>{e=r.trim()});let o=!1;n.inputEl.addEventListener("keydown",r=>{r.key==="Enter"&&(o=!0)}),n.inputEl.addEventListener("keyup",r=>{o&&r.key==="Enter"&&(e=n.getValue().trim(),this.submitModal(e,t,"edit"))})}).addText(n=>{n.setPlaceholder("Tooltip").setValue(t).onChange(o=>{t=o.trim()}).inputEl.addEventListener("keyup",o=>{o.key==="Enter"&&(t=n.getValue().trim(),this.submitModal(e,t,"edit"))})});let s=new F.Setting(i);this.selectedAbbr&&s.addButton(n=>{n.setButtonText("Delete").setWarning().onClick(()=>{this.submitModal(e,t,"delete")})}),s.addButton(n=>{n.setButtonText("Submit").setCta().onClick(()=>{this.submitModal(e,t,"edit")})})}onClose(){let{contentEl:e}=this;e.empty()}};var q=require("obsidian"),W=class W extends q.FuzzySuggestModal{constructor(e,t,i,s){super(e),this.abbrList=t,this.selectedText=i,this.action=s,this.emptyStateText="No abbreviations found.",this.setPlaceholder("Type the search term")}onOpen(){let e=this.selectedText.replace(/\n/," ").trim();this.inputEl.value=e,this.inputEl.dispatchEvent(new InputEvent("input"))}getItems(){return this.abbrList}getItemText(e){return`${e.key}: ${e.title}`}onChooseItem(e){this.action(e,"edit")}renderSuggestion(e,t){let i=t.createDiv("abbreviations-plugin-list-item-main"),s=i.createSpan("abbreviations-plugin-list-item-suggestion");(0,q.renderResults)(s,`${e.item.key}: ${e.item.title}`,e.match);let n=i.createSpan("abbreviations-plugin--list-item-buttons");(e.item.type==="metadata"||e.item.type==="extra")&&n.createEl("button",{cls:W.ButtonCls,text:"Global",title:"Add it to global abbreviations"}).onClickEvent(o=>{o.stopPropagation(),this.action(e.item,"global"),this.close()}),t.createEl("small",{text:`type: ${e.item.type}`+(e.item.position?` - postion: ${e.item.position}`:"")})}};W.ButtonCls="abbreviations-plugin--list-item-button";var R=W;var gt=require("obsidian"),vt=require("@codemirror/view");var G=class{constructor(e){this.menuAction=e}readingViewDomHandlers(e){let t=e.target;if(t&&t.classList.contains(y)){let i=t.dataset.abbrType,s=t.dataset.abbrKey;if(!i||!s)return;e.preventDefault(),e.stopPropagation();let n=t.title,o=parseInt(t.dataset.abbrPosition||"")||-1,r={key:s,type:i,title:n,position:o};this.menuGenerator(r).showAtMouseEvent(e)}}editorViewDomHandlers(){return vt.EditorView.domEventHandlers({contextmenu:e=>{let t=e.target;if(t)if(t.classList.contains(y)){let i=t.dataset.abbrType,s=t.dataset.abbrKey;if(!i||!s)return!1;e.preventDefault(),e.stopPropagation();let n=t.title,o=parseInt(t.dataset.abbrPosition||"")||-1,r={key:s,type:i,title:n,position:o};return this.menuGenerator(r).showAtMouseEvent(e),!0}else{let i=t.closest("."+M);if(i){let s=i.dataset.abbrKey;if(!s)return!1;e.preventDefault(),e.stopPropagation();let n=i.dataset.abbrTitle||"",o={key:s,type:"extra",title:n,position:-1};return this.menuGenerator(o,!0).showAtMouseEvent(e),!0}}return!1}})}menuGenerator(e,t=!1){let i=new gt.Menu;return i.addItem(s=>{s.setTitle(`Type: ${t?"definition":e.type}`).setIcon("type").setDisabled(!0)}),i.addItem(s=>{s.setTitle(`Text: ${e.key}`).setIcon("whole-word").setDisabled(!0)}),i.addItem(s=>{s.setTitle(`Title: ${e.title}`).setIcon("message-square-quote").setDisabled(!0)}),e.type==="extra"&&!t&&i.addItem(s=>{s.setTitle(`Line: ${e.position}`).setIcon("map-pin").setDisabled(!0)}),i.addSeparator(),t||i.addItem(s=>s.setTitle("Edit abbreviation").setIcon("square-pen").onClick(()=>{this.menuAction(e,"edit")})),(e.type==="metadata"||e.type==="extra")&&i.addItem(s=>{s.setTitle("Add to global abbreviations").setIcon("square-plus").onClick(()=>{this.menuAction(e,"global")})}),i.addSeparator(),i.addItem(s=>{s.setTitle("Copy abbreviation text").setIcon("copy").onClick(()=>{this.menuAction(e,"copy-text")})}),e.title&&i.addItem(s=>{s.setTitle("Copy abbreviation title").setIcon("copy").onClick(()=>{this.menuAction(e,"copy-title")})}),i.addItem(s=>{s.setTitle("Copy metadata format definition").setIcon("copy").onClick(()=>{this.menuAction(e,"copy-metadata")})}),i.addItem(s=>{s.setTitle("Copy extra format definition").setIcon("copy").onClick(()=>{this.menuAction(e,"copy-extra")})}),i.addItem(s=>{s.setTitle("Copy HTML format definition").setIcon("copy").onClick(()=>{this.menuAction(e,"copy-html")})}),i}};var Pt={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","&":"&amp;"};function L(a){return a.replace(/[<>"'&]/g,e=>Pt[e])}function Lt(a,e){let t=[],i=0;return e.forEach(s=>{s.index>i&&t.push(a.substring(i,s.index)),t.push(`<abbr title="${L(s.title)}">${L(s.text)}</abbr>`),i=s.index+s.text.length}),i<a.length&&t.push(a.substring(i)),t.join("")}function yt(a,e,t,i,s,n=!1){let o=[],r=new v(e,t,{metadata:!0,extra:i}),d=a.split(`
`);for(let h=0;h<d.length;h++){let c=d[h],p=h+1;if(r.handler(c,p),!i&&!r.isMetadataState())break}let f=new E(r.abbreviations,i,s,n),l=!1;for(let h=0;h<d.length;h++){let c=d[h],p=h+1;f.handler(c,p,(u,g)=>{if(!f.isMetadataState()){if(c===""){if(l&&o.at(-1)===""){l=!1;return}o.push(""),l=!1;return}if(g){l=!0;return}u.length===0?o.push(c):o.push(Lt(c,u)),l=!1}})}return o.join(`
`)}var Nt={metadataKeyword:"abbr",detectCJK:!1,detectAffixes:!1,affixes:"",markInSourceMode:!1,globalAbbreviations:[],useMarkdownExtraSyntax:!1,useExtraDefinitionDecorator:!1,extraDefinitionDecoratorOpacity:20,extraDefinitionDecoratorContent:"\u2192 ${abbr}"},H=class extends b.Plugin{constructor(){super(...arguments);this.debouncedSaveSettings=(0,b.debounce)(this.rerenderPreviewMarkdown.bind(this),1e3,!0)}async onload(){await this.loadSettings(),this.registerEditorExtension([ut,mt,this.createAbbrViewPlugin(this.getPluginData.bind(this))]),this.registerMarkdownPostProcessor(async(i,s)=>{var n;if(this.settings.useMarkdownExtraSyntax){let o=i.findAll(".el-p > p");for(let h of o)h.textContent&&lt(h.textContent)&&h.classList.add(_);let r=i.findAll(I);if(r.length===0)return;let d=r.filter(h=>h.nodeName!=="P"||!h.classList.contains(_));if(d.length===0)return;let f=new v(this.settings.globalAbbreviations,this.settings.metadataKeyword,{extra:!0});f.readAbbreviationsFromCache(s.frontmatter);let l=this.getActiveFile(s.sourcePath);l&&(await this.app.vault.cachedRead(l)).split(`
`).forEach((c,p)=>{f.handler(c,p+1)}),ft(s,d,f.abbreviations,this.getAffixList(),this.settings.detectCJK)}else{let o=i.findAll(I);if(o.length===0)return;let r=s.frontmatter;if(this.settings.metadataKeyword&&!r&&(i.classList.contains("table-cell-wrapper")||i.classList.contains("markdown-rendered"))){let f=this.getActiveFile(s.sourcePath);f&&(r=(n=this.app.metadataCache.getFileCache(f))==null?void 0:n.frontmatter)}let d=this.getAbbrList(r);O(o,d,this.getAffixList(),this.settings.detectCJK)}}),this.registerEvent(this.app.metadataCache.on("changed",(0,b.debounce)(i=>{var s;this.settings.metadataKeyword&&i&&i.path===((s=this.getActiveFile())==null?void 0:s.path)&&this.rerenderPreviewMarkdown(i)},250,!0))),this.registerEvent(this.app.workspace.on("active-leaf-change",this.handleModeChange.bind(this))),this.registerEvent(this.app.workspace.on("layout-change",this.handleModeChange.bind(this)));let t=new G(this.abbreviationActionHandler.bind(this));this.registerDomEvent(this.app.workspace.containerEl,"contextmenu",t.readingViewDomHandlers.bind(t)),this.registerEditorExtension(t.editorViewDomHandlers()),this.addCommand({id:"add-abbreviation",name:"Add abbreviation",checkCallback:i=>this.settings.metadataKeyword?(i||this.showAddMetaAbbreviationModal(),!0):!1}),this.addCommand({id:"copy-with-format",name:"Copy and format content",callback:()=>{this.copyAndFormatContent()}}),this.addCommand({id:"insert-extra-definition",name:"Insert extra definition",editorCheckCallback:i=>this.settings.useMarkdownExtraSyntax?(i||this.insertExtraDefinition(),!0):!1}),this.addCommand({id:"list-abbreviations",name:"List abbreviations",callback:()=>{this.showAbbreviationListModal()}}),this.addCommand({id:"manage-global-abbreviations",name:"Manage global abbreviations",callback:()=>{this.showManageAbbreviationsModal()}}),this.addRibbonIcon("text-search","List abbreviations",()=>{this.showAbbreviationListModal()}),this.addSettingTab(new et(this.app,this))}onunload(){}async loadSettings(){this.settings=Object.assign({},Nt,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.debouncedSaveSettings()}createAbbrViewPlugin(t){return xt.ViewPlugin.fromClass(class extends K{constructor(i){super(i,t)}})}handleModeChange(){let t=this.app.workspace.getActiveViewOfType(b.MarkdownView);if(t){let i=t.getMode()==="source",s=t.editor.cm;s&&s.dispatch({effects:V.of(i)})}}getAbbrList(t){let i=this.settings.globalAbbreviations.map(({key:n,title:o})=>({key:n,title:o,type:"global"})).filter(n=>n.key),s=D(t,this.settings.metadataKeyword);return i.push(...s),i}rerenderPreviewMarkdown(t){let i=this.app.workspace.getActiveViewOfType(b.MarkdownView);i&&(!t||t===i.file)&&i.previewMode.rerender(!0)}async getPluginData(){var n;let{metadataKeyword:t,...i}=this.settings,s={metadataKeyword:t,frontmatterCache:void 0,suffixes:this.getAffixList(),...i};if(t){let o=this.getActiveFile();o&&(s.frontmatterCache=(n=this.app.metadataCache.getFileCache(o))==null?void 0:n.frontmatter)}return s}getAffixList(){return this.settings.detectAffixes?ct(this.settings.affixes):void 0}getActiveFile(t){return t?this.app.vault.getFileByPath(t):this.app.workspace.getActiveFile()}async copyAndFormatContent(){let t=this.getActiveFile();if(t){let i=await this.app.vault.cachedRead(t),s=yt(i,this.settings.globalAbbreviations,this.settings.metadataKeyword,this.settings.useMarkdownExtraSyntax,this.getAffixList(),this.settings.detectCJK);try{await navigator.clipboard.writeText(s),this.sendNotification("Formatted content has been copied!")}catch(n){this.sendNotification("Error: Unable to copy content!")}}}insertExtraDefinition(){var i;let t=(i=this.app.workspace.activeEditor)==null?void 0:i.editor;if(t){let s=t.getSelection(),n=s?`*[${s}]: `:"*[]: ",o=t.getCursor();s?t.replaceSelection(n):t.replaceRange(n,o),t.setCursor({line:o.line,ch:o.ch+(s?s.length+5:2)})}}showAddMetaAbbreviationModal(){var i;let t=(i=this.app.workspace.activeEditor)==null?void 0:i.editor;if(t){let s=t.getSelection();new P(this.app,s,this.addAbbreviationToFrontmatter.bind(this)).open()}}async showAbbreviationListModal(){var n,o;let t=[],i="",s=this.getActiveFile();if(s){let r=(n=this.app.metadataCache.getFileCache(s))==null?void 0:n.frontmatter;if(this.settings.useMarkdownExtraSyntax){let f=new v(this.settings.globalAbbreviations,this.settings.metadataKeyword,{extra:!0});f.readAbbreviationsFromCache(r),(await this.app.vault.cachedRead(s)).split(`
`).forEach((h,c)=>{f.handler(h,c+1)}),t=f.abbreviations}else t=this.getAbbrList(r);let d=(o=this.app.workspace.activeEditor)==null?void 0:o.editor;d&&(i=d.getSelection()),new R(this.app,t,i,this.abbreviationActionHandler.bind(this)).open()}}showManageAbbreviationsModal(){new it(this.app,this).open()}addAbbreviationToFrontmatter(t,i){try{this.strictCheckAbbreviationFormat(t);let s=this.strictGetMetadataKeyword(),n=this.strictGetActiveFile();this.app.fileManager.processFrontMatter(n,o=>{if(this.checkFrontmatter(o)){let r=`${t}: ${i}`;Array.isArray(o[s])?o[s].push(r):o[s]=[r],this.sendNotification(`Added metadata abbreviation: ${t}.`)}})}catch(s){this.sendErrorNotification(s)}}modifyAbbreviationInFrontmatter(t,i,s){try{this.strictCheckAbbreviationFormat(i);let n=this.strictGetMetadataKeyword(),o=this.strictGetActiveFile();this.app.fileManager.processFrontMatter(o,r=>{if(this.checkFrontmatter(r)){let d=Q(t,r,n);if(d>-1){let f=`${i}: ${s}`;r[n][d]=f}else this.sendNotFoundWarn()}})}catch(n){this.sendErrorNotification(n)}}deleteAbbreviationFromFrontmatter(t){try{let i=this.strictGetMetadataKeyword(),s=this.strictGetActiveFile();this.app.fileManager.processFrontMatter(s,n=>{if(this.checkFrontmatter(n)){let o=Q(t,n,i);o>-1&&(n[i].splice(o,1),this.sendNotification(`Deleted metadata abbreviation: ${t.key}.`))}})}catch(i){this.sendErrorNotification(i)}}modifyAbbreviationInGlobal(t,i,s){if(!S(i)){this.sendFormatWarn();return}let n=X(t,this.settings.globalAbbreviations);n>-1?(this.settings.globalAbbreviations[n]={key:i,title:s},this.saveSettings()):this.sendNotFoundWarn()}deleteAbbreviationFromGlobal(t){let i=X(t,this.settings.globalAbbreviations);i>-1&&(this.settings.globalAbbreviations.splice(i,1),this.saveSettings(),this.sendNotification(`Deleted global abbreviation: ${t.key}.`))}async abbreviationActionHandler(t,i){var s;if(i==="edit")if(t.type==="extra"){let n=(s=this.app.workspace.activeEditor)==null?void 0:s.editor;if(n){let o=this.app.workspace.getActiveViewOfType(b.MarkdownView);if(o){let d=o.getMode()==="preview";d&&this.app.commands.executeCommandById("markdown:toggle-preview")}let r=t.position-1;n.setCursor(r>=0?r:0)}}else new P(this.app,t,(n,o,r)=>{r==="delete"?t.type==="metadata"?this.deleteAbbreviationFromFrontmatter(t):t.type==="global"&&this.deleteAbbreviationFromGlobal(t):r==="edit"&&(t.type==="metadata"?this.modifyAbbreviationInFrontmatter(t,n,o):t.type==="global"&&this.modifyAbbreviationInGlobal(t,n,o))}).open();else if(i==="global")this.settings.globalAbbreviations.push({key:t.key,title:t.title}),await this.saveSettings(),this.sendNotification(`Added ${t.key} to global abbreviations.`);else if(i.includes("copy")){let n="";switch(i){case"copy-text":n=t.key;break;case"copy-title":n=t.title;break;case"copy-metadata":n=`${t.key}: ${t.title}`;break;case"copy-extra":n=`*[${t.key}]: ${t.title}`;break;case"copy-html":n=`<abbr title="${L(t.title)}">${L(t.key)}</abbr>`;break}if(n)try{await navigator.clipboard.writeText(n),this.sendNotification("Content has been copied!")}catch(o){this.sendNotification("Error: Unable to copy content!")}else this.sendNotification("Warn: The copied content is empty!")}}checkFrontmatter(t){return typeof t=="object"&&t?!0:(this.sendNotification("Error: Unexpected error!"),!1)}strictCheckAbbreviationFormat(t){if(!S(t))throw new Error("Warn: Abbreviation format is incorrect!")}strictGetMetadataKeyword(){let t=this.settings.metadataKeyword;if(t)return t;throw new Error("Error: Metadata keyword is empty!")}strictGetActiveFile(){let t=this.getActiveFile();if(t)return t;throw new Error("Error: No active file found!")}sendErrorNotification(t){t instanceof Error&&this.sendNotification(t.message)}sendFormatWarn(){this.sendNotification("Warn: Abbreviation format is incorrect!")}sendNotFoundWarn(){this.sendNotification("Warn: No original abbreviation found!")}sendNotification(t){new b.Notice(t)}},et=class extends b.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty();let t=new b.Setting(e).setName("Metadata keyword").addText(c=>c.setPlaceholder("Enter the keyword").setValue(this.plugin.settings.metadataKeyword).onChange(async p=>{this.plugin.settings.metadataKeyword=p.trim(),await this.plugin.saveSettings()})),i=createFragment();i.append("The key name that reads the abbreviation information from the ",createEl("a",{href:"https://help.obsidian.md/Editing+and+formatting/Properties",text:"properties"}),"."),t.descEl.appendChild(i),new b.Setting(e).setName("Mark abbreviations in Source mode").setDesc("In Source mode, mark abbreviations just like in Live Preview and Reading view.").addToggle(c=>{c.setValue(this.plugin.settings.markInSourceMode).onChange(async p=>{this.plugin.settings.markInSourceMode=p,await this.plugin.saveSettings()})});let s=new b.Setting(e).setName("Enable abbreviation detection for languages not separated by spaces").addToggle(c=>{c.setValue(this.plugin.settings.detectCJK).onChange(async p=>{this.plugin.settings.detectCJK=p,await this.plugin.saveSettings()})}),n=createFragment();n.append("Detect abbreviations in languages that do not use spaces for word segmentation, such as ",createEl("abbr",{text:"CJK",title:"Chinese, Japanese, Korean"}),"."),s.descEl.appendChild(n);let o=new b.Setting(e).setName("Global abbreviations").addButton(c=>{c.setButtonText("Manage abbreviations").onClick(()=>{this.displayGlobalAbbreviations()})}),r=createFragment();r.append("Configure global abbreviations, but their priority is lower than ",createEl("a",{href:"https://help.obsidian.md/Editing+and+formatting/Properties",text:"properties"}),"."),o.descEl.appendChild(r),new b.Setting(e).setName("Markdown extra syntax").setHeading();let d=new b.Setting(e).setName("Enable Markdown Extra syntax support").addToggle(c=>{c.setValue(this.plugin.settings.useMarkdownExtraSyntax).onChange(async p=>{this.plugin.settings.useMarkdownExtraSyntax=p,await this.plugin.saveSettings()})}),f=createFragment();f.append("Toggle this setting to enable or disable the feature. Definition format: ",createEl("b",{text:"*[W3C]: World Wide Web Consortium"}),"."),d.descEl.appendChild(f),new b.Setting(e).setName("Enable extra definition decorator").setDesc("Display a decorator at the end of the extra definition that this is an abbreviation definition.").addToggle(c=>{c.setValue(this.plugin.settings.useExtraDefinitionDecorator).onChange(async p=>{this.plugin.settings.useExtraDefinitionDecorator=p,await this.plugin.saveSettings()})}),new b.Setting(e).setName("Extra definition decorator opacity").setDesc("Opacity of the extra definition decorator. The value is the form of percentage.").addSlider(c=>{c.setLimits(10,100,10).setValue(this.plugin.settings.extraDefinitionDecoratorOpacity).onChange(async p=>{this.plugin.settings.extraDefinitionDecoratorOpacity=this.isOpacityValue(p)?p:20,await this.plugin.saveSettings()}).setDynamicTooltip()}),new b.Setting(e).setName("Extra definition decorator content").setDesc("Content of the extra definition decorator. Two variables can be used: ${abbr} and ${tooltip}. To introduce certain information of the current definition into the content.").addText(c=>{c.setValue(this.plugin.settings.extraDefinitionDecoratorContent).onChange(async p=>{this.plugin.settings.extraDefinitionDecoratorContent=p,await this.plugin.saveSettings()})}),new b.Setting(e).setName("Suffixes").setHeading(),new b.Setting(e).setName("Enable detect suffixes").setDesc("Detect supplementary suffixes for abbreviations.").addToggle(c=>{c.setValue(this.plugin.settings.detectAffixes).onChange(async p=>{this.plugin.settings.detectAffixes=p,await this.plugin.saveSettings()})});let l=new b.Setting(e).setName("Suffix list").addText(c=>{c.setPlaceholder("A string separated by ,").setValue(this.plugin.settings.affixes).onChange(async p=>{this.plugin.settings.affixes=p.trim(),await this.plugin.saveSettings()})}),h=createFragment();h.append("The list content uses comma-separated string, for example: ",createEl("b",{text:"s, es, less"}),"."),l.descEl.appendChild(h)}displayGlobalAbbreviations(){let{containerEl:e}=this;j(this.plugin,e,()=>{new b.Setting(e).setName("Global abbreviations").setHeading().addButton(t=>{t.setButtonText("Back").onClick(()=>{this.display()})})})}isOpacityValue(e){return e>=10&&e<=100&&e%10===0}},it=class extends b.Modal{constructor(e,t){super(e),this.plugin=t}onOpen(){let{contentEl:e}=this;j(this.plugin,e,()=>{this.setTitle("Manage global abbreviations")})}onClose(){let{contentEl:e}=this;e.empty()}};function j(a,e,t){e.empty(),t(),a.settings.globalAbbreviations.forEach((i,s)=>{new b.Setting(e).setName("Abbreviation:").addText(n=>n.setPlaceholder("Short word").setValue(i.key).onChange(async o=>{a.settings.globalAbbreviations[s].key=o.trim(),await a.saveSettings()})).addText(n=>n.setPlaceholder("Tooltip").setValue(i.title).onChange(async o=>{a.settings.globalAbbreviations[s].title=o.trim(),await a.saveSettings()})).addButton(n=>n.setButtonText("Delete").setWarning().onClick(async()=>{a.settings.globalAbbreviations.splice(s,1),await a.saveSettings(),j(a,e,t);}))}),new b.Setting(e).addButton(i=>i.setButtonText("Add").setCta().setTooltip("Add new abbreviation").onClick(async()=>{a.settings.globalAbbreviations.push({key:"",title:""}),await a.saveSettings(),j(a,e,t);}))}
//! `-` and `&` not considered a special character
//! empty line
//! Delay trigger rerender
//! Toggle reading view to editing view.
//! Rerender

/* nosourcemap */